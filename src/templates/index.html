{% extends "layouts/base.html" %}

{% block title %} Dashboard {% endblock %} 

{% block stylesheets %}{% endblock stylesheets %}

{% block content %}
<div class="content">
  <div class="row">
    {% if sentiment_summary %}
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">
          <div class="card mb-4">
            <div class="card-body">
              <h4>Crypto: {{ crypto_id }}</h4>
                <ul>
                  <li><strong>Average Sentiment Score:</strong> {{ sentiment_summary.average_score }}</li>
                  <li class="text-success"><strong>Positive Posts:</strong> {{ sentiment_summary.positive }}</li>
                  <li class="text-secondary"><strong>Neutral Posts:</strong> {{ sentiment_summary.neutral }}</li>
                  <li class="text-danger"><strong>Negative Posts:</strong> {{ sentiment_summary.negative }}</li>
                </ul>

                <h5 class="card-title text-success mt-3">Most Positive Post</h5>
                <p>{{ sentiment_summary.most_positive.Text }}</p>
                <small class="text-muted">Score: {{ sentiment_summary.most_positive.SentimentScore }}</small>

                <h5 class="card-title text-danger mt-3">Most Negative Post</h5>
                <p>{{ sentiment_summary.most_negative.Text }}</p>
                <small class="text-muted">Score: {{ sentiment_summary.most_negative.SentimentScore }}</small>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card card-chart">
        <div class="card-header">
          <div class="row">
            <div class="col-sm-6 text-left">
              <h5 class="card-category">Average Sentiment Over Time</h5>
              <h2 class="card-title">Crypto News Sentiment</h2>
            </div>
          </div>
        </div>
        <div class="card-body">
          <!-- Average Sentiment Chart -->
          <div class="chart-area text-center">
            <canvas id="avgSentimentChart" height="200"></canvas>
          </div>

          <hr>

          <!-- POS/NEU/NEG Area Chart -->
          <div class="chart-area text-center">
            <h5 class="card-category mt-3">Pos/Neu/Neg Over Time</h5>
            <canvas id="sentimentAreaChart" height="200"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card-body">
    <table class="table tablesorter">
      <thead class="text-primary">
        <tr>
          <th>Date</th>
          <th>Sentiment Score</th>
          <th>Article</th>
          <th>Source</th>
        </tr>
      </thead>
      <tbody>
        {% for article in articles %}
        <tr>
          <td>{{ article.date }}</td>
          <td>{{ article.SentimentScore }}</td>
          <td>
            <a href="/article/{{ article.url | urlencode }}">
              {{ article.text }}
            </a>
          </td>
          <td>{{ article.source }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Average Sentiment Line Chart
  const avgData = {{ avg_chart_data | tojson }};
  const ctxAvg = document.getElementById('avgSentimentChart').getContext('2d');
  new Chart(ctxAvg, {
      type: 'line',
      data: {
          labels: avgData.dates,
          datasets: [{
              label: 'Average Sentiment',
              data: avgData.values,
              borderColor: 'blue',
              backgroundColor: 'rgba(0,0,255,0.1)',
              fill: true
          }]
      },
      options: {
          responsive: true,
          plugins: { legend: { labels: { color: 'black' } } },
          scales: {
              x: { ticks: { color: 'black' } },
              y: { ticks: { color: 'black' } }
          }
      }
  });

  // POS/NEU/NEG Stacked Area Chart
  const areaData = {{ area_chart_data | tojson }};
  const ctxArea = document.getElementById('sentimentAreaChart').getContext('2d');
  new Chart(ctxArea, {
      type: 'line',
      data: {
          labels: areaData.dates,
          datasets: [
              {
                  label: 'Positive',
                  data: areaData.positive,
                  borderColor: '#2ca02c',
                  backgroundColor: 'rgba(44,160,44,0.3)',
                  fill: true
              },
              {
                  label: 'Neutral',
                  data: areaData.neutral,
                  borderColor: '#ff7f0e',
                  backgroundColor: 'rgba(255,127,14,0.3)',
                  fill: true
              },
              {
                  label: 'Negative',
                  data: areaData.negative,
                  borderColor: '#d62728',
                  backgroundColor: 'rgba(214,39,40,0.3)',
                  fill: true
              }
          ]
      },
      options: {
          responsive: true,
          plugins: { legend: { labels: { color: 'black' } } },
          scales: {
              x: { stacked: true, ticks: { color: 'black' } },
              y: { stacked: true, ticks: { color: 'black' } }
          }
      }
  });
</script>
{% endblock content %}
